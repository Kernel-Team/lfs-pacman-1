#!/bin/bash -e

. $(dirname ${0})/shared.sh

install -dm755 ${LFS}/{etc,dev,proc}
install -dm755 ${LFS}/var/lib/pacman
install -dm755 ${LFS}/var/cache/pacman/pkg

/tools/bin/pacman -D -kk

mknod -m 600 ${LFS}/dev/console c 5 1
mknod -m 666 ${LFS}/dev/null c 1 3

mount --bind /dev ${LFS}/dev
mount --bind /dev/pts ${LFS}/dev/pts

mount -t proc none ${LFS}/proc

cat > ${LFS}/etc/group << EOF
root:x:0:root
pkgbuild:x:${PKGBUILD_ID}:pkgbuild
EOF

cat > ${LFS}/etc/passwd << EOF
root:x:0:0:root:/:/tools/bin/bash
pkgbuild:x:${PKGBUILD_ID}:${PKGBUILD_ID}:pkgbuild:${BUILDDIR}:/tools/bin/bash
EOF

lfs_chroot_build_temp filesystem

umount ${LFS}/dev/pts ${LFS}/dev ${LFS}/proc

rm -rf ${LFS}/{dev,etc,proc}

lfs_pacman_install_temp filesystem

ln -sf /tools/bin/{bash,cat,dd,echo,install} ${LFS}/usr/bin
ln -sf /tools/bin/{ln,perl,pwd,rm,stty} ${LFS}/usr/bin

ln -sf /tools/lib/libgcc_s.so{,.1} ${LFS}/usr/lib
ln -sf /tools/lib/libstdc++.so{,.6} ${LFS}/usr/lib
ln -sf /tools/lib/libc++.so{,.1} ${LFS}/usr/lib
ln -sf /tools/lib/libc++abi.so{,.1} ${LFS}/usr/lib
ln -sf /tools/lib/libomp.so ${LFS}/usr/lib

ln -sf /tools/lib32/libgcc_s.so{,.1} ${LFS}/usr/lib32
ln -sf /tools/lib32/libstdc++.so{,.6} ${LFS}/usr/lib32
ln -sf /tools/lib32/libc++.so{,.1} ${LFS}/usr/lib32
ln -sf /tools/lib32/libc++abi.so{,.1} ${LFS}/usr/lib32
ln -sf /tools/lib32/libomp.so ${LFS}/usr/lib32

ln -sf bash ${LFS}/usr/bin/sh

cp -L /etc/resolv.conf ${LFS}/etc/resolv.conf

if [ "$(hostname)" == "krejzi" ]
then
	install -dm755 ${LFS}/media/ntfs
	install -m644 /media/ntfs/chromium-api.sh ${LFS}/media/ntfs
	install -m644 /media/ntfs/*-api.key ${LFS}/media/ntfs
fi

PKGS=(linux-api-headers
glibc
rpcsvc-proto
tzdata
pkg-config
libtirpc
libnsl
libnss_compat
zlib
file
m4
bison
flex
attr
acl
gmp
mpfr
mpc
ncurses
readline
bzip2
xz
pcre
pcre2
libatomic_ops
ed
sed
gc
binutils
gcc
libutil-linux
e2fsprogs
procps-ng
bc
psmisc
cracklib
libcap-ng
openssl
tcl
db
pam
libcap
bash
coreutils
grep
shadow
expat
gdbm
libffi
libtool
sqlite
hostname
run-parts
which
perl
python2
python3
autoconf
autoconf2.13
automake
diffutils
findutils
gawk
gperf
groff
gzip
make
patch
tar
texinfo
check
libmnl
libnftnl
iptables
less
libpipeline
iproute2
kbd
kmod
man-db
nano
unzip
zip
perl-archive-zip
perl-error
perl-parse-yapp
perl-sgmls
perl-uri
perl-xml-parser
icu
libunistring
boost
libgpg-error
libgcrypt
libidn
libidn2
libmetalink
libxml2
libxslt
libpsl
lua
highlight
ca-certificates
wget
docbook-xml
docbook-xsl
intltool
itstool
xmlto
sgml-common
docbook
docbook-dsssl
opensp
openjade
python-six
asciidoc
docbook-utils
gtk-doc
glib
libcroco
gettext
python-setuptools
python-alabaster
python-beaker
python-certifi
python-chardet
python-cssselect
python-idna
python-imagesize
python-markupsafe
python-pyparsing
python-pygments
python-pytz
python-pyxdg
python-snowballstemmer
python-typing
python-urllib3
python-babel
python-docutils
python-jinja2
python-lxml
python-mako
python-requests
python-sphinx
python-sphinxcontrib-websupport
python-sphinx_rtd_theme
elfutils
gobject-introspection
libaio
libedit
libnghttp2
libpng
libsasl
libssh2
libtasn1
libuv
lz4
lzo
nettle
nspr
nss
openldap
p11-kit
popt
rtmpdump
vala
chrpath
gnutls
krb5
libarchive
curl
cyrus-sasl
libmicrohttpd
libuser
pixman
swig
cmake
llvm
freetype
fontconfig
util-macros
bigreqsproto
compositeproto
damageproto
dmxproto
dri2proto
dri3proto
fixesproto
fontsproto
glproto
inputproto
kbproto
presentproto
randrproto
recordproto
renderproto
resourceproto
scrnsaverproto
videoproto
xcmiscproto
xextproto
xf86bigfontproto
xf86dgaproto
xf86driproto
xf86vidmodeproto
xineramaproto
xproto
xcb-proto
xtrans
libxau
libxdmcp
libxcb
libx11
libxext
libfs
libice
libsm
libxscrnsaver
libxt
libxmu
libxpm
libxaw
libxfixes
libxcomposite
libxrender
libxcursor
libxdamage
libfontenc
libxfont2
libxft
libxi
libxinerama
libxrandr
libxpresent
libxres
libxtst
libxv
libxvmc
libxxf86dga
libxxf86vm
libdmx
libpciaccess
libxkbfile
libxshmfence
xcb-util
xcb-util-errors
xcb-util-image
xcb-util-keysyms
xcb-util-renderutil
xcb-util-wm
xcb-util-cursor
pciutils
qrencode
wayland
wayland-protocols
xkeyboard-config
gnu-efi-libs
libseccomp
libxkbcommon
libsystemd
lvm2
cryptsetup
util-linux
systemd
cairo
graphite2
harfbuzz
freetype
libdrm
libusb
libusb-compat
fakeroot
iana-etc
usbutils
libassuan
libksba
npth
gnupg
gpgme
pacman
dbus
dbus-glib
dbus-python
htop
intel-ucode
lsb-release
man-pages
nasm
scons
yasm
apr
apr-util
fuse2
fuse3
guile
libevent
libical
libgnome-keyring
libgudev
libsecret
serf
tk
yaml
bluez
git
ntfs-3g
ruby
subversion
linux-firmware
linux
libclc
libomxil-bellagio
libunwind
libva
libva-utils
libvdpau
opencl-headers
ocl-icd
vulkan-loader
mesa
libva
glu
freeglut
glew
libjpeg-turbo
tiff
giflib
jasper
lcms2
libmng
libwebp
desktop-file-utils
hicolor-icon-theme
shared-mime-info
atk
gdk-pixbuf
pango
librsvg
links
xdg-utils
libdaemon
libgusb
libpaper
mozjs
polkit
colord
libavahi
cups
gtk2
libepoxy
libevdev
mtdev
libwacom
libinput
at-spi2-core
at-spi2-atk
json-glib
gtk3
adwaita-icon-theme
avahi
cantarell-fonts
dconf
gnome-themes-standard
gsettings-desktop-schemas
xbitmaps
xorg-font-util
xorg-iceauth
xorg-luit
xorg-mkfontdir
xorg-mkfontscale
xorg-sessreg
xorg-setxkbmap
xorg-smproxy
xorg-x11perf
xorg-xauth
xorg-xbacklight
xorg-xcmsdb
xorg-xcursorgen
xorg-xdpyinfo
xorg-xdriinfo
xorg-xev
xorg-xgamma
xorg-xhost
xorg-xinput
xorg-xkbcomp
xorg-xkbevd
xorg-xkbutils
xorg-xkill
xorg-xlsatoms
xorg-xlsclients
xorg-xmessage
xorg-xmodmap
xorg-xpr
xorg-xprop
xorg-xrandr
xorg-xrdb
xorg-xrefresh
xorg-xset
xorg-xsetroot
xorg-xvinfo
xorg-xwd
xorg-xwininfo
xorg-xwud
xcursor-themes
xorg-server
xf86-input-libinput
xf86-input-wacom
xf86-video-amdgpu
xf86-video-intel
weston
cldr-emoji-annotation
iso-codes
libnotify
pycairo
pygobject
unicode-emoji
ibus
talloc
tdb
tevent
ldb
fftw
jansson
libmbim
libndp
libnl
libpcap
libsoup
slang
libqmi
libteam
newt
dhcp
modemmanager
ppp
wpa_supplicant
networkmanager
json-c
libasyncns
orc
alsa-lib
libogg
libvorbis
libtheora
cdparanoia
flac
libvisual
speexdsp
speex
libsndfile
opus
sbc
soxr
webrtc-audio-processing
pulseaudio
alsa-plugins
alsa-utils
beignet
clinfo
intel-vaapi-driver
libtxc_dxtn
libvdpau-va-gl
mesa-demos
gstreamer
gst-plugins-base
aspell
hunspell
hyphen
enchant
geoclue
sdl2
portaudio
openal-soft
mpg123
libproxy
libvpx
startup-notification
wireless_tools
aspell-en
aspell-hr
hunspell-en
hunspell-hr
fonts-baekmuk
fonts-cm-unicode
fonts-corefonts
fonts-dejavu
fonts-freefont
fonts-gentiumbasic
fonts-gentiumplus
fonts-hack
fonts-hannom
fonts-liberation
fonts-noto
fonts-noto-cjk
fonts-noto-emoji
fonts-opendesktop
fonts-scheherazade
fonts-vlgothic
dmz-cursor-theme
mime-types
glib-networking
re2c
ninja
meson
dotconf
espeak
libao
minizip
speech-dispatcher
qtbase
qtimageformats
qtnetworkauth
qtscript
qtserialport
qtsvg
qtx11extras
qtxmlpatterns
qtdeclarative
qtcanvas3d
qtcharts
qtconnectivity
qtdatavis3d
qtgamepad
qtgraphicaleffects
qtlocation
qtmultimedia
qtquickcontrols
qtquickcontrols2
qtscxml
qtsensors
qtserialbus
qtspeech
qttools
qtvirtualkeyboard
qtwayland
qtwebchannel
qtwebsockets
qtwebkit
samba
djvulibre
fribidi
ijs
ilmbase
libexif
libgd
libieee1284
libraw
libssh
net-snmp
openjpeg
qpdf
exiv2
ghostscript
libgphoto2
mupdf
openexr
poppler
graphviz
imagemagick
libdvdread
libdvdnav
libdvdcss
libcddb
libcdio
libcdio-paranoia
v4l-utils
chromaprint
fdk-aac
lame
libass
libbluray
libcanberra
libmtp
libnfs
libshout
luajit
neon
taglib
uchardet
vo-aacenc
vo-amrwbenc
wavpack
x264
x265
xvidcore
ffmpeg
mpv
gst-plugins-good
gst-plugins-bad
gst-plugins-ugly
gst-libav
gstreamer-vaapi
webkitgtk
gcr
pinentry
media-player-info
mobile-broadband-provider-info
cups-filters
cups-pk-helper
dmraid
editorconfig-core-c
exempi
gptfdisk
gsl
gtkspell3
libatasmart
libbytesize
libdmtx
libgit2
libgsf
libkpathsea
liboauth
libpwquality
libqalculate
libspectre
libxklavier
libzip
lm_sensors
lmdb
mdadm
node
nss-mdns
parted
pkcs11-helper
sane-backends
t1lib
tidy-html5
volume-key
xapian-core
xfsprogs
ytnef
zziplib
bogofilter
ebook-tools
hplip
libblockdev
libpst
doxygen
udisks
upower
chromium
pepper-flash
bind
openssh
rtkit
cogl
geocode-glib
gmime
rest
telepathy-glib
clutter
colord-gtk
gjs
gnome-autoar
gnome-desktop
gnome-menus
gnome-online-accounts
gnome-video-effects
gspell
gtksourceview
libcryptui
libgee
libgepub
libgtop
libgweather
libgxps
libpeas
libwnck
network-manager-applet
telepathy-logger
telepathy-mission-control
totem-pl-parser
tracker
uhttpmock
vte
vte2
yelp-xsl
zenity
accountsservice
clutter-gst
clutter-gtk
gnome-backgrounds
gnome-bluetooth
gnome-settings-daemon
grilo
libgdata
mutter
nautilus
tepl
caribou
cheese
evince
evolution-data-server
gnome-keyring
yelp
aisleriot
eog
epiphany
evolution
file-roller
gdm
gedit
gnome-calculator
gnome-control-center
gnome-disk-utility
gnome-session
gnome-tweak-tool
gvfs
latexila
seahorse
simple-scan
xdg-user-dirs
xdg-user-dirs-gtk
gnome-shell
gnome-shell-extensions
gnome-terminal
gnome-user-docs
mailnag
perl-file-remove
perl-inc-latest
perl-test-requires
perl-yaml-tiny
perl-module-build
perl-module-scandeps
perl-module-install
perl-net-ssleay
perl-io-socket-ssl
perl-net-smtp-ssl
perl-digest-hmac
perl-authen-sasl
geany
gthumb
hexchat
transmission
dosfstools
gdb
iputils
linux-tools
lsof
netkit-telnet
strace
sudo
traceroute
unrar
valgrind
whois
texlive
dblatex
libfprint
fprintd
openssl098
viber
vfs495-driver
youtube-dl
extra-cmake-modules
libdbusmenu-qt
phonon
polkit-qt
qca
qgpgme
attica
bluez-qt
breeze-icons
kapidox
karchive
kcodecs
kconfig
kcoreaddons
kdbusaddons
kdnssd
kguiaddons
ki18n
kidletime
kitemmodels
kitemviews
kplotting
kwayland
kwidgetsaddons
kwindowsystem
modemmanager-qt
networkmanager-qt
oxygen-icons
prison
solid
sonnet
syntax-highlighting
threadweaver
kactivities
kauth
kcompletion
kcrash
kdoctools
kfilemetadata
kimageformats
kjobwidgets
knotifications
kpty
kunitconversion
kactivities-stats
kconfigwidgets
kglobalaccel
kpackage
kservice
kdesu
kemoticons
kiconthemes
kpeople
ktextwidgets
kwallet
kxmlgui
kbookmarks
kio
baloo
kdeclarative
kinit
knewstuff
knotifyconfig
kparts
kxmlrpcclient
frameworkintegration
kcmutils
kded
kdewebkit
ktexteditor
plasma-framework
kdesignerplugin
kirigami2
krunner
qqc2-desktop-style
kdelibs4support
kjs
kmediaplayer
kross
khtml
kjsembed
kholidays
kactivitymanagerd
kde-cli-tools
kdecoration
kscreenlocker
libkscreen
libksysguard
milou
breeze
oxygen
kwayland-integration
kwin
plasma-integration
bluedevil
breeze-gtk
drkonqi
kde-gtk-config
kinfocenter
kscreen
ksysguard
systemsettings
plasma-workspace
khotkeys
kmenuedit
plasma-nm
plasma-workspace-wallpapers
polkit-kde-agent-1
powerdevil
plasma-desktop
kdeplasma-addons)

for pkg in "${PKGS[@]}"
do
  pushd "$(dirname $(realpath $0))/pkgbuild/${pkg}"
    rm -f $(dirname $(realpath $0))/${pkg}.log.gz
    ./build 2>&1 | tee $(dirname $(realpath $0))/${pkg}.log
    gzip $(dirname $(realpath $0))/${pkg}.log
  popd
done

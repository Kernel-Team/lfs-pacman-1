#!/bin/bash -e

. $(dirname ${0})/shared.sh

install -dm755 ${LFS}/{etc,dev,proc}
install -dm755 ${LFS}/var/lib/pacman
install -dm755 ${LFS}/var/cache/pacman/pkg

/tools/bin/pacman -D -kk

mknod -m 600 ${LFS}/dev/console c 5 1
mknod -m 666 ${LFS}/dev/null c 1 3

mount --bind /dev ${LFS}/dev
mount --bind /dev/pts ${LFS}/dev/pts

mount -t proc none ${LFS}/proc

cat > ${LFS}/etc/group << EOF
root:x:0:root
pkgbuild:x:${PKGBUILD_ID}:pkgbuild
EOF

cat > ${LFS}/etc/passwd << EOF
root:x:0:0:root:/:/tools/bin/bash
pkgbuild:x:${PKGBUILD_ID}:${PKGBUILD_ID}:pkgbuild:${BUILDDIR}:/tools/bin/bash
EOF

lfs_chroot_build_temp filesystem

umount ${LFS}/dev/pts ${LFS}/dev ${LFS}/proc

rm -rf ${LFS}/{dev,etc,proc}

lfs_pacman_install_temp filesystem

ln -sf /tools/bin/{bash,cat,dd,echo,install} ${LFS}/usr/bin
ln -sf /tools/bin/{ln,perl,pwd,rm,stty} ${LFS}/usr/bin

ln -sf /tools/lib/libgcc_s.so{,.1} ${LFS}/usr/lib
ln -sf /tools/lib/libstdc++.so{,.6} ${LFS}/usr/lib
ln -sf /tools/lib/libc++.so{,.1} ${LFS}/usr/lib
ln -sf /tools/lib/libc++abi.so{,.1} ${LFS}/usr/lib
ln -sf /tools/lib/libomp.so ${LFS}/usr/lib

ln -sf /tools/lib32/libgcc_s.so{,.1} ${LFS}/usr/lib32
ln -sf /tools/lib32/libstdc++.so{,.6} ${LFS}/usr/lib32
ln -sf /tools/lib32/libc++.so{,.1} ${LFS}/usr/lib32
ln -sf /tools/lib32/libc++abi.so{,.1} ${LFS}/usr/lib32
ln -sf /tools/lib32/libomp.so ${LFS}/usr/lib32

ln -sf bash ${LFS}/usr/bin/sh

cp -L /etc/resolv.conf ${LFS}/etc/resolv.conf

if [ "$(hostname)" == "krejzi" ]
then
	install -dm755 ${LFS}/media/ntfs
	install -m644 /media/ntfs/chromium-api.sh ${LFS}/media/ntfs
	install -m644 /media/ntfs/*-api.key ${LFS}/media/ntfs
fi

PKGS=(linux-api-headers
glibc
rpcsvc-proto
tzdata
pkg-config
libtirpc
libnsl
libnss_nis
zlib
file
m4
bison
flex
attr
acl
gmp
mpfr
mpc
ncurses
readline
bzip2
xz
pcre
pcre2
libatomic_ops
ed
sed
gc
binutils
gcc
libutil-linux
e2fsprogs
procps-ng
bc
psmisc
cracklib
libcap-ng
openssl
tcl
db
pam
libcap
bash
coreutils
grep
shadow
expat
gdbm
libffi
libtool
sqlite
hostname
run-parts
which
perl
python2
python3
autoconf
autoconf2.13
automake
diffutils
findutils
gawk
gperf
groff
gzip
make
patch
tar
texinfo
check
libmnl
libnftnl
iptables
less
libpipeline
iproute2
kbd
kmod
man-db
nano
unzip
zip
perl-archive-zip
perl-error
perl-parse-yapp
perl-sgmls
perl-uri
perl-xml-parser
icu
libunistring
boost
libgpg-error
libgcrypt
libidn
libidn2
libmetalink
libxml2
libxslt
libpsl
lua
highlight
ca-certificates
wget
docbook-xml
docbook-xsl
intltool
itstool
xmlto
sgml-common
docbook
docbook-dsssl
opensp
openjade
asciidoc
docbook-utils
python-setuptools
python-six
python-alabaster
python-beaker
python-certifi
python-chardet
python-cssselect
python-idna
python-imagesize
python-markupsafe
python-packaging
python-pyparsing
python-pygments
python-pytz
python-pyxdg
python-snowballstemmer
python-typing
python-urllib3
python-babel
python-docutils
python-jinja2
python-lxml
python-mako
python-requests
python-sphinx
python-sphinxcontrib-websupport
python-sphinx_rtd_theme
elfutils
gtk-doc
glib
libcroco
gettext
gobject-introspection
json-c
libaio
libedit
libnghttp2
libpng
libsasl
libssh2
libtasn1
libuv
lz4
lzo
nettle
nspr
nss
openldap
p11-kit
popt
rtmpdump
vala
chrpath
gnutls
krb5
libarchive
curl
cyrus-sasl
libmicrohttpd
libuser
pixman
swig
cmake
llvm
freetype
fontconfig
util-macros
xorgproto
xcb-proto
xtrans
libxau
libxdmcp
libxcb
libx11
libxext
libfs
libice
libsm
libxscrnsaver
libxt
libxmu
libxpm
libxaw
libxfixes
libxcomposite
libxrender
libxcursor
libxdamage
libfontenc
libxfont2
libxft
libxi
libxinerama
libxrandr
libxpresent
libxres
libxtst
libxv
libxvmc
libxxf86dga
libxxf86vm
libdmx
libpciaccess
libxkbfile
libxshmfence
xcb-util
xcb-util-errors
xcb-util-image
xcb-util-keysyms
xcb-util-renderutil
xcb-util-wm
xcb-util-cursor
pciutils
qrencode
wayland
wayland-protocols
xkeyboard-config
gnu-efi-libs
libseccomp
libxkbcommon
libsystemd
lvm2
cryptsetup
util-linux
systemd
cairo
graphite2
harfbuzz
freetype
libdrm
libusb
libusb-compat
fakeroot
iana-etc
usbutils
libassuan
libksba
npth
gnupg
gpgme
pacman
dbus
dbus-glib
dbus-python
htop
intel-ucode
lsb-release
man-pages
nasm
scons
yasm
apr
apr-util
fuse2
fuse3
guile
libevent
libical
libgudev
libsecret
serf
tk
yaml
bluez
git
ntfs-3g
ruby
rust
subversion
linux-firmware
linux
libunwind
libva
libva-utils
libvdpau
opencl-headers
ocl-icd
vulkan
mesa
libva
glu
freeglut
glew
libjpeg-turbo
tiff
fribidi
giflib
jasper
lcms2
libmng
libwebp
desktop-file-utils
hicolor-icon-theme
shared-mime-info
atk
gdk-pixbuf
pango
librsvg
links
xdg-utils
libdaemon
libgusb
libpaper
libsass
mozjs
polkit
sassc
colord
libavahi
cups
gtk2
libepoxy
libevdev
mtdev
libwacom
libinput
at-spi2-core
at-spi2-atk
json-glib
libsoup
gcab
gtk3
adwaita-icon-theme
appstream-glib
avahi
cantarell-fonts
dconf
gnome-themes-extra
gsettings-desktop-schemas
xbitmaps
xorg-font-util
xorg-iceauth
xorg-luit
xorg-mkfontdir
xorg-mkfontscale
xorg-sessreg
xorg-setxkbmap
xorg-smproxy
xorg-x11perf
xorg-xauth
xorg-xbacklight
xorg-xcmsdb
xorg-xcursorgen
xorg-xdpyinfo
xorg-xdriinfo
xorg-xev
xorg-xgamma
xorg-xhost
xorg-xinput
xorg-xkbcomp
xorg-xkbevd
xorg-xkbutils
xorg-xkill
xorg-xlsatoms
xorg-xlsclients
xorg-xmessage
xorg-xmodmap
xorg-xpr
xorg-xprop
xorg-xrandr
xorg-xrdb
xorg-xrefresh
xorg-xset
xorg-xsetroot
xorg-xvinfo
xorg-xwd
xorg-xwininfo
xorg-xwud
xcursor-themes
xorg-server
xf86-input-libinput
xf86-input-wacom
xf86-video-amdgpu
weston
cldr-emoji-annotation
iso-codes
libnotify
pycairo
pygobject
unicode-character-database
unicode-emoji
ibus
talloc
tdb
tevent
ldb
fftw
jansson
libmbim
libndp
libnl
libpcap
slang
libqmi
libteam
newt
dhcp
modemmanager
ppp
wpa_supplicant
networkmanager
libasyncns
orc
alsa-lib
libogg
libvorbis
libtheora
cdparanoia
flac
libvisual
speexdsp
speex
libsndfile
opus
sbc
soxr
webrtc-audio-processing
pulseaudio
alsa-plugins
alsa-utils
clinfo
intel-vaapi-driver
libvdpau-va-gl
mesa-demos
gstreamer
gst-plugins-base
aspell
hunspell
hyphen
enchant
geoclue
sdl2
portaudio
openal-soft
mpg123
libproxy
libvpx
startup-notification
wireless_tools
aspell-en
aspell-hr
hunspell-en
hunspell-hr
fonts-baekmuk
fonts-cm-unicode
fonts-corefonts
fonts-dejavu
fonts-freefont
fonts-gentiumbasic
fonts-gentiumplus
fonts-hack
fonts-hannom
fonts-liberation
fonts-noto
fonts-noto-cjk
fonts-noto-emoji
fonts-opendesktop
fonts-scheherazade
fonts-vlgothic
dmz-cursor-theme
mime-types
glib-networking
minizip
re2c
ninja
meson
qtbase
qtscript
qtsvg
qtx11extras
qtxmlpatterns
qtdeclarative
qtlocation
qtmultimedia
qtquickcontrols
qtsensors
qttools
qtwebchannel
qtwebkit
samba
djvulibre
ijs
ilmbase
libexif
libgd
libieee1284
libraw
libssh
net-snmp
openjpeg
qpdf
exiv2
ghostscript
libgphoto2
mupdf
openexr
poppler
graphviz
imagemagick
libcddb
libcdio
libcdio-paranoia
libdvdread
libdvdnav
libdvdcss
v4l-utils
chromaprint
fdk-aac
lame
libass
libbluray
libcanberra
libmtp
libnfs
libshout
luajit
neon
taglib
uchardet
vo-aacenc
vo-amrwbenc
wavpack
x264
x265
xvidcore
ffmpeg
mpv
smplayer
smplayer-skins
smplayer-themes
gst-plugins-good
gst-plugins-bad
gst-plugins-ugly
gst-libav
gstreamer-vaapi
webkitgtk
gcr
pinentry
media-player-info
mobile-broadband-provider-info
c-ares
cups-filters
cups-pk-helper
dmraid
exempi
gptfdisk
gsl
gtkspell3
http-parser
libatasmart
libbytesize
libgsf
libkpathsea
liboauth
libpwquality
libspectre
libxklavier
lm_sensors
mdadm
nss-mdns
parted
sane-backends
strongswan
t1lib
tidy-html5
volume_key
xapian-core
xfsprogs
ytnef
zziplib
bogofilter
doxygen
hplip
libblockdev
libpst
nodejs
udisks
upower
google-chrome
bind
openssh
rtkit
cogl
geocode-glib
gmime
rest
telepathy-glib
clutter
colord-gtk
gexiv2
gjs
gnome-autoar
gnome-desktop
gnome-menus
gnome-online-accounts
gnome-video-effects
gspell
gtksourceview
gtksourceview4
libcryptui
libgee
libgtop
libgweather
libgxps
libpeas
libwnck
network-manager-applet
telepathy-logger
telepathy-mission-control
totem-pl-parser
tracker
uhttpmock
vte
vte2
yelp-xsl
zenity
accountsservice
clutter-gst
clutter-gtk
gnome-backgrounds
gnome-bluetooth
gnome-settings-daemon
grilo
libgdata
mutter
nautilus
tepl
caribou
cheese
evince
evolution-data-server
gnome-keyring
gvfs
networkmanager-strongswan
yelp
folks
aisleriot
eog
epiphany
evolution
evolution-ews
file-roller
gdm
gedit
gnome-calculator
gnome-control-center
gnome-disk-utility
gnome-latex
gnome-session
gnome-tweaks
seahorse
simple-scan
gnome-shell
gnome-shell-extensions
gnome-terminal
gnome-user-docs
mailnag
xdg-user-dirs
xdg-user-dirs-gtk
perl-file-remove
perl-inc-latest
perl-test-requires
perl-yaml-tiny
perl-module-build
perl-module-scandeps
perl-module-install
perl-net-ssleay
perl-io-socket-ssl
perl-net-smtp-ssl
perl-digest-hmac
perl-authen-sasl
geany
gthumb
hexchat
transmission
dosfstools
gdb
iputils
linux-tools
lsof
netkit-telnet
strace
sudo
traceroute
unrar
valgrind
whois
texlive-texmf
texlive-bin
dblatex
libgconf
teamviewer
viber
visual-studio-code
youtube-dl)

for pkg in "${PKGS[@]}"
do
  pushd "$(dirname $(realpath $0))/pkgbuild/${pkg}"
    rm -f $(dirname $(realpath $0))/${pkg}.log.gz
    ./build 2>&1 | tee $(dirname $(realpath $0))/${pkg}.log
    gzip $(dirname $(realpath $0))/${pkg}.log
  popd
done

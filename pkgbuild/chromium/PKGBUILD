pkgname=chromium
pkgver=61.0.3163.100
_launcher_ver=5
pkgrel=1
pkgdesc="A web browser built for speed, simplicity, and security"
arch=('x86_64')
url="https://www.chromium.org/Home"
license=('BSD')
#depends=()
source=("https://commondatastorage.googleapis.com/chromium-browser-official/chromium-${pkgver}.tar.xz"
	"chromium-launcher-${_launcher_ver}.tar.gz::https://github.com/foutrelis/chromium-launcher/archive/v${_launcher_ver}.tar.gz"
	"chromium.desktop"
	"breakpad-use-ucontext_t.patch"
	"chromium-atk-r1.patch"
	"chromium-gn-bootstrap-r14.patch")

_system_libs=(
  flac
  harfbuzz-ng
  libdrm
  libjpeg
  libpng
  libwebp
  libxml
  libxslt
  opus
  yasm
  zlib
)

# ffmpeg
# freetype
# icu
# libvpx

_config=(
	'is_debug=false'
	'enable_nacl=false'
	'enable_hangout_services_extension=true'
	'enable_widevine=false'
	'use_cups=true'
	'use_gconf=false'
	'use_gnome_keyring=false'
	'use_gtk3=true'
	'use_kerberos=true'
	'use_pulseaudio=true'
	'fieldtrial_testing_like_official_build=true'
	'is_clang=true'
	'clang_use_chrome_plugins=false'
	'use_gold=false'
	'use_sysroot=false'
	'linux_use_bundled_binutils=false'
	'proprietary_codecs=true'
	'ffmpeg_branding="Chrome"'
	'treat_warnings_as_errors=false'
	'fatal_linker_warnings=false'
	'use_custom_libcxx=false'
)

if [ "$(hostname)" == "krejzi" ]
then
	. /media/ntfs/chromium-api.sh

	_config+=(
		"google_api_key=\"${_google_api_key}\""
		"google_default_client_id=\"${_google_default_client_id}\""
		"google_default_client_secret=\"${_google_default_client_secret}\""
	)
fi

prepare() {
	cd "${srcdir}/chromium-${pkgver}"

	for _lib in ${_system_libs[@]} libjpeg_turbo
	do
		find -type f -path "*third_party/${_lib}/*"        \
			\! -path "*third_party/${_lib}/chromium/*" \
			\! -path "*third_party/${_lib}/google/*"   \
			\! -path "*base/third_party/icu/*"         \
			\! -regex '.*\.\(gn\|gni\|isolate\|py\)'   \
			-delete
	done

	python build/linux/unbundle/replace_gn_files.py --system-libraries ${_system_libs[@]}

	install -v -dm755 third_party/node/linux/node-linux-x64/bin
	ln -sfv /usr/bin/node third_party/node/linux/node-linux-x64/bin/node

	install -v -dm755 third_party/llvm-build/Release+Asserts/bin
	ln -sfv /usr/bin/clang third_party/llvm-build/Release+Asserts/bin/clang
	ln -sfv /usr/bin/clang++ third_party/llvm-build/Release+Asserts/bin/clang++
	ln -sfv /usr/bin/llvm-ar third_party/llvm-build/Release+Asserts/bin/llvm-ar

	sed -i "/-Wno-unused-lambda-capture/d" build/config/compiler/BUILD.gn

	patch -Np1 -i "${srcdir}/breakpad-use-ucontext_t.patch"
	patch -Np1 -i "${srcdir}/chromium-gn-bootstrap-r14.patch"
	patch -Np1 -i "${srcdir}/chromium-atk-r1.patch"
}

build() {
	cd "${srcdir}/chromium-launcher-${_launcher_ver}"

	make

	cd "${srcdir}/chromium-${pkgver}"

	export TMPDIR="${srcdir}/temp"
	install -v -dm755 "${TMPDIR}"

	python tools/gn/bootstrap/bootstrap.py --gn-gen-args "${_config[*]}"
	out/Release/gn gen out/Release --args="${_config[*]}"

	ninja -C out/Release chrome chrome_sandbox chromedriver
}

package() {
	cd "${srcdir}/chromium-launcher-${_launcher_ver}"

	make install PREFIX=/usr DESTDIR="${pkgdir}"

	cd "${srcdir}/chromium-${pkgver}"

	install -v -Dm755 out/Release/chrome "${pkgdir}/usr/lib/chromium/chromium"
	install -v -Dm4755 out/Release/chrome_sandbox "${pkgdir}/usr/lib/chromium/chrome-sandbox"

	install -v -Dm755 out/Release/chromedriver "${pkgdir}/usr/lib/chromium/chromedriver"
	ln -sfv ../lib/chromium/chromedriver "${pkgdir}/usr/bin/chromedriver"

	install -v -Dm644 out/Release/icudtl.dat "${pkgdir}/usr/lib/chromium/icudtl.dat"

	cp -a out/Release/*.pak out/Release/*.bin out/Release/locales "${pkgdir}/usr/lib/chromium"

	install -v -Dm644 "${srcdir}/chromium.desktop" "${pkgdir}/usr/share/applications/chromium.desktop"

	for size in 16 32
	do
		install -v -Dm644 "chrome/app/theme/default_100_percent/chromium/product_logo_${size}.png" \
			"${pkgdir}/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png"
	done

	for size in 22 24 48 64 128 256
	do
		install -v -Dm644 "chrome/app/theme/chromium/product_logo_${size}.png" \
			"${pkgdir}/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png"
	done

	install -v -Dm644 out/Release/chrome.1 "${pkgdir}/usr/share/man/man1/chromium.1"
}

sha512sums=('4dfd3a493ceb7c605eeab6f387541273d529e8b935a6104927e34836469aedcfcbb4a1154591585621d5c2e842e68701d32328acba842f840a20498822165f78'
            '52fa910e2fff7197d670be41e925c71579f10bcdc879248b38876581dc7e4f384262a0e1d3714ed7b6382d680c56e53076b0be6fea679724360144395bf3973a'
            '41175d53e7dba3405ff154d52f2069c7685ecb7ce2587b982bc24e30951485686586848eb94d5033a98ddde6dc1fd13cc5614a95e8758133d1a579a5f6b9221d'
            '776ed0ee0020e3e0559d219447f2cad66da1ca176abc2e204bfcaad5141e115336290fe7d210e7e1d02b163a8039b8678f4b33edcd1874ecfddaf5c8172e9e1e'
            '5722c571ffc384e0e226342d170e29109bf45761dcd7202b2fe6572795e0a04bd0521b1120eb2247c2a84bed0e63f47a71d25802528992ee4f976b348fb5c8f6'
            'd297728681538fd6d6d48da4477e6e42b0ac1585a243dca60c0d9896387a1bf17770aa70966344c8d3551b774cbea6d6acbeaa0dbbfc3c17367dda5daa912297')

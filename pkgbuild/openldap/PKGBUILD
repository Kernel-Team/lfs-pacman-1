pkgname=openldap
pkgver=2.4.44
pkgrel=1
url="http://www.openldap.org/"
arch=('x86_64')
url="http://www.openldap.org/"
license=('custom')
backup=(etc/openldap/ldap.conf
	etc/openldap/slapd.conf
	etc/openldap/slapd.ldif)
options=(emptydirs)
#depends=()
source=("ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-${pkgver}.tgz"
	"openldap-blfs-paths.patch"
	"openldap-symbol-versions.patch"
	"slapd.default"
	"slapd.service"
	"slapd.sysusers"
	"slapd.tmpfiles")

prepare() {
	cd "${srcdir}/openldap-${pkgver}"

	patch -Np1 -i "${srcdir}/openldap-blfs-paths.patch"
	patch -Np1 -i "${srcdir}/openldap-symbol-versions.patch"

	autoconf
}

build() {
	cd "${srcdir}/openldap-${pkgver}"

	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--libexecdir=/usr/lib \
		--disable-debug \
		--enable-dynamic \
		--enable-crypt \
		--enable-modules \
		--enable-rlookups \
		--enable-backends=mod \
		--enable-overlays=mod \
		--disable-bdb \
		--disable-hdb \
		--disable-ndb \
		--disable-sql \
		--enable-spasswd

	make depend
	make
}

package() {
	cd "${srcdir}/openldap-${pkgver}"

	make install DESTDIR="${pkgdir}"

	rm -rf "${pkgdir}/var/run"
	install -dm755 "${pkgdir}/etc/openldap/slapd.d" "${pkgdir}/var/lib/openldap"

	install -v -Dm644 "${srcdir}/slapd.default" "${pkgdir}/etc/default/slapd"
	install -v -Dm644 "${srcdir}/slapd.service" "${pkgdir}/lib/systemd/system/slapd.service"

	install -v -Dm644 "${srcdir}/slapd.sysusers" "${pkgdir}/usr/lib/sysusers.d/slapd.conf"
	install -v -Dm644 "${srcdir}/slapd.tmpfiles" "${pkgdir}/usr/lib/tmpfiles.d/slapd.conf"

	chmod 700 "${pkgdir}/etc/openldap/slapd.d" "${pkgdir}/var/lib/openldap"
	chown -R 83:83 "${pkgdir}/etc/openldap/slapd.d" "${pkgdir}/var/lib/openldap"

	chmod 640 "${pkgdir}/etc/openldap/slapd.conf" "${pkgdir}/etc/openldap/slapd.ldif"
	chown root:83 "${pkgdir}/etc/openldap/slapd.conf" "${pkgdir}/etc/openldap/slapd.ldif"
}

md5sums=('693ac26de86231f8dcae2b4e9d768e51'
         'e7ec324d539cc6462611df340b4419da'
         'f39582c00ed6e17a143745fae2fc0da3'
         '198fadd97fe7917eeca785efc287d35e'
         '79ebedb7c0f826cce3d3f1211a12c09b'
         '8bf5a4e8960ca8dcf985774d0db0afe9'
         '1061156ae6d8a58e2498ae2ed40db952')
